---
title: "Reproducible Research: Peer Assessment 1"
author: "Mathieu C."
output: 
  html_document:
    keep_md: true
---
The file "activity.zip" was originally from [this url](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2Factivity.zip).

## Loading and preprocessing the data
We start by unzipping the file and loading the csv file within.
```{r}
unzip("activity.zip")
act_raw <- read.csv("activity.csv")
```
We then take a look on what's inside:
```{r}
str(act_raw); summary(act_raw)
```
From this we realize:  
A) There are missing values in the "steps" variable.
B) The dates are factors. Not that bad, but the best  
thing to do is to convert them to actual dates.
```{r}
act_pro <- transform(act_raw, date = as.Date(date, "%Y-%m-%d"))
```
Let's check this out:
```{r}
str(act_pro)
```

## What is mean total number of steps taken per day?
For this, we will need additionnal packages:
```{r message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
```
We start by grouping the data by date, we will do this by creating a new  
dataframe:
```{r}
df_by_day <- act_pro %>% group_by(date) %>% 
        summarise(steps_by_day = sum(steps, na.rm = F),
                  nb_NA = sum(is.na(steps)))
table(df_by_day$nb_NA)
```
The variable "nb_NA" clearly shows the repartition of the NA's : Either a  
day has 288 values (one by interval) or none (288 NA's). This will help us  
in the future.  

For now, we want a histogram of the steps taken each day. This will show the repartition of the sums.
```{r}
hist1 <- qplot(steps_by_day, data = df_by_day, binwidth = 1000)+
        ylab("Count (number of days)")+
        xlab("Number of steps (unit)")+
        labs(title = "Histogram of the total steps taken by day.",
             subtitle = "Median in red.")+
        geom_vline(xintercept = median(df_by_day$steps_by_day, na.rm = T),
                   color = 2) +
        theme_bw()
        print(hist1)
```

A quick call to summary will tell us more about the mean and median.
```{r}
summary(df_by_day$steps_by_day)
```  
We can clearly see that the totals gravitate around the median (see above)  
with a rather central pattern.

## What is the average daily activity pattern?
There we need a new data frame grouped by intervals. Let's do this and take a look.
```{r Creating the df_inter dataframe}
df_inter <- act_pro %>%
        group_by(interval) %>%
        summarise(mean_by_interval = round(mean(steps, na.rm = T), 4))
head(df_inter, 10)
```
We can easily extract the highest value with the **which.max** function to know  
which of the intervals has the highest mean and store this into variables.
```{r}
max_index <- which.max(df_inter$mean_by_interval)
max_interval <- as.numeric(paste(df_inter$interval[max_index]))
max_mean <- df_inter$mean_by_interval[max_index]
print(df_inter[max_index,])
```
We then construct the plot with the help of the variables **max_interval & max_mean** to help  
make the max value clear:
```{r}
g1 <- ggplot(df_inter, aes(as.numeric(paste(interval)), mean_by_interval))+ 
        geom_line() +
        theme_bw() +
        ylab("Mean steps taken during interval (all days merged)") +
        xlab("Interval ID (5 minutes intervals)") +
        geom_vline(xintercept = max_interval, color = "steelblue", lty = 2) +
        scale_x_continuous(breaks = c(seq(from= 0, to = 2000, by=500),
                                      max_interval,
                                      seq(from= 1000, to = 2000, by=500))) +
        annotate(geom = "text",
                 x = max_interval+300,
                 y = max_mean,
                 label = paste0("Max value:", max_mean),
                 color = "steelblue")
g1
```



## Imputing missing values
From the previous exploration, we can see many variations in term of values during one day, it makes more sense to me to replace the NA's with the mean of their interval across all days.  

For this we will use the previously created **df_inter** data frame.  
df_inter contains exactly 288 lines, one per interval, along with the matching mean.  

```{r}
act_compl <- act_pro
act_compl <- merge(act_compl, df_inter, sort = F)
act_compl <- transform(act_compl, steps = ifelse(is.na(steps), mean_by_interval, steps))
act_compl <- act_compl[order(act_compl$date, act_compl$interval), -4]
```

```{r}
df_by_day_compl<- act_compl %>% group_by(date) %>% 
        summarise(steps_by_day = sum(steps, na.rm = F),
                  nb_NA = sum(is.na(steps)))
hist2 <- ggplot(df_by_day_compl, aes(steps_by_day))+
        geom_histogram(binwidth = 1000) +
        ylab("Count (number of days)")+
        xlab("Number of steps (unit)")+
        labs(title = "Histogram of the total steps taken by day.",
             subtitle = "Median in red. NA values replaced by mean of interval.")+
        geom_vline(xintercept = median(df_by_day_compl$steps_by_day, na.rm = T),
                   color = 2)+
        theme_bw()
hist2;hist1 + ylim(c(0,15))
```
If we take a look at the histograms, we can see that filling the NA's with "basic" approaches such as means or medians tend to centralize data, hence eventually skewing group tendencies.

Here's the summary with NA replaced:
```{r}
summary(df_by_day_compl$steps_by_day)
```
And the original values (see above) with NA's:
```{r}
summary(df_by_day$steps_by_day)
```

So unless needed for some kind of model, I would leave the NA's as is.


## Are there differences in activity patterns between weekdays and weekends?

First thing, we will add the variable **weekday** to the act_pro dataframe and add another variable, **day_group**   which will be used as the main group_by variable.

```{r}
act_pro <- transform(act_pro, weekday = weekdays(date, abbreviate = F))

## This line is a cheap way to be sure to catch the weekend days names even if the system is in a different
## language
weekend_days <- c(weekdays(as.Date("2019-09-28")), weekdays(as.Date("2019-09-29")))
####

act_pro <- transform(act_pro, day_group = ifelse(act_pro$weekday %in% weekend_days, "Weekend", "Weekday"))
table(act_pro$day_group)

```
We can see that (as expected) there are more weekdays than weekend days.
Let's create the graph:
```{r}
g2 <- act_pro %>%
    group_by(interval, day_group) %>%
    summarize(mean_steps = mean(steps, na.rm = T)) %>%
    ggplot(., aes(interval, mean_steps))
g2 <- g2 + geom_smooth(col = 2, alpha = 0.5)
g2 <- g2 + geom_line() + facet_grid(day_group~.) + theme_bw()
g2 <- g2 + ylab("Mean of steps during interval") + xlab("Interval ID")
g2
```
We have a clear answer here: There **IS** a rather evident shift in activity pattern  
between weekdays and weekend. The activity is shifted towards higher Interval  
ID's (aka: later in the day) and is higher in these later timepoints.  
The overall mean of activity is also higher during the weekends as seen below:

```{r}
mean_wd <- mean(act_pro$steps[act_pro$day_group == "Weekday"], na.rm = T)
mean_we <- mean(act_pro$steps[act_pro$day_group == "Weekend"], na.rm = T)
names(mean_wd) <- "Mean during Weekdays"
names(mean_we) <- "Mean during Weekends"
mean_wd;mean_we
```

